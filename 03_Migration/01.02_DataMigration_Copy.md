# Data Migration with Redis COPY Command

## Setup

Follow all the steps in the [Setup](./../05_Appendix/00_Setup.md) guide to create an environment to support the following steps.

## Configure Server Parameters

To support the migration, set the source and target Redis instance parameters to allow for faster egress and ingress. Follow the steps in [Server Parameters Migration](./02.03_DataMigration_ServerParams_Ingress.md).

## Install PgBouncer

To gain the performance benefits of PgBouncer, follow all the steps in the [Configure PgBouncer](../05_Appendix/05_ConfigurePgBouncer.md) guide to install PgBouncer.  Replace all references to port `5432` with port `6432`.

## Schema

Typically, a COPY-based migration requires the target to contain the migrated schema. Follow the steps in the [Migrate schema](./02.01_DataMigration_Schema.md) document.

## Data

For larger instances with many tables and a small window for the migration, parallelize the import using a scripting environment, such as PowerShell, and the COPY command.

### COPY

- Switch to the **PREFIX-vm-pgdb01** virtual machine
- Create a new PowerShell script in `c:\temp\migrate_copy.ps1` using the code below, update the PowerShell script with the local instance and the Redis target instance information.

```PowerShell
function GetData($connString, $sql, $outputFile)
{
    $env:PGPASSWORD = $connString.Password;

    Write-Host "$global:psqlPath\psql.exe -h $($connString.Host) -p $($connString.Port) -U $($connString.User) -d $($connstring.DbName) -c `"$sql;`"";

    if ($connString.useSSL)
    {
        $env:PGSSLMODE = "require";
    }
        
    $data = $sql | & $global:psqlPath\psql.exe -h $($connString.Host) -p $($connString.Port) -U $($connString.User) -d $($connstring.DbName) -c `"$sql`";

    return $data;
}

function  ExportAllTables($source)
{
    #get the list of tables...
    $sql = "select table_name, table_schema from information_schema.tables where table_type = 'BASE TABLE' and table_schema = '$($source.dbname)' order by table_name;";
    $data = GetData $source $sql $outputFile;

    foreach($item in $data)
    {
        if ($item.contains("table_name") -or $item.contains("rows)") -or $item.contains("-+-"))
        {
            continue;
        }

        $tableName, $schemaName = $item.split('|');

        if ( $tableName)
        {
            $tableName = $tableName.replace(" ","");
            $schemaName = $schemaName.replace(" ","");
            $fullName = $schemaName + "." + $tablename;

            mkdir "c:/export/$schemaName" -ea SilentlyContinue;

            $sql = "COPY (SELECT * FROM $fullName) TO 'c:/export/$schemaName/$($tableName).copy';";

            #export via psql...
            $data = GetData $source $sql $outputFile;
        }
    }
}

function ImportAllTables($source, $target)
{
    #get the list of tables...
    $sql = "select table_name, table_schema from information_schema.tables where table_type = 'BASE TABLE' and table_schema = '$($source.dbname)' order by table_name;";
    $data = GetData $source $sql $outputFile;

    foreach($item in $data)
    {
        if ($item.contains("table_name") -or $item.contains("rows)") -or $item.contains("-+-"))
        {
            continue;
        }

        $tableName, $schemaName = $item.split('|');

        if ( $tableName)
        {
            $tableName = $tableName.replace(" ","");
            $schemaName = $schemaName.replace(" ","");
            $fullName = $schemaName + "." + $tablename;

            #truncate the table first...
            $sql = "truncate table $fullName;";
            $res = GetData $target $sql $outputFile;

            #import the data...
            $sql = "\COPY $fullName FROM 'c:/export/$schemaName/$($tableName).copy';";
            $res = GetData $target $sql $outputFile;
        }
    }
}

$global:psqlPath = "C:\Program Files\Redis\10\bin";

$sourceConnStringA = @{};
$sourceConnStringA.Host = "localhost";
$sourceConnStringA.Port = "5432";
$sourceConnStringA.User = "postgres";
$sourceConnStringA.Password = "Seattle123";
$sourceConnStringA.DbName = "reg_app";
$sourceConnStringA.UseSSL = $false;

$targetConnStringA = @{};
$targetConnStringA.Host = "servername.postgres.instance.azure.com";
$targetConnStringA.Port = "5432";
$targetConnStringA.User = "s2admin@servername";
$targetConnStringA.Password = "Seattle123Seattle123";
$targetConnStringA.DbName = "reg_app";
$targetConnStringA.UseSSL = $true;
```

- Run the PowerShell script to start the migration

```PowerShell
. c:\temp\migrate_copy.ps1

ExportAllTables $sourceConnStringA;

ImportAllTables $sourceConnStringA $targetConnStringA;
```

## Revert Server Parameters

With the migration completed, revert the server parameters of both instances to support the workload. Follow the steps in [Server Parameters Reset](./02.03_DataMigration_ServerParams_Revert.md).

### Enable Keys and Triggers

As the final step, run the SQL to add all foreign keys and enable all triggers. Refer to the Schema Migration document for more information.

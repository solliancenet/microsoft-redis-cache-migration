# Data Migration with Redis (Mass Insertion)

## Setup

Follow all the steps in the [Setup](./../05_Appendix/00_Setup.md) guide to create an environment to support the following steps.

## Mass Insertion (SET)

- Run the following command to explore all keys and values to a file

```bash
TODO
```

- Run the following command to import all keys and values

```bash
TODO
```

## Mass Insertion (DUMP/RESTORE)

TODO

```bash
export OLD="redis-cli -h foo.0001.usw2.cache.amazonaws.com"
export NEW="redis-cli -h bar.clustercfg.usw2.cache.amazonaws.com"


for KEY in $($OLD --scan); do
    $OLD --raw DUMP "$KEY" | head -c-1 > /tmp/dump
    TTL=$($OLD --raw TTL "$KEY")
    case $TTL in
        -2)
            $NEW DEL "$KEY"
            ;;
        -1)
            $NEW DEL "$KEY"
            cat /tmp/dump | $NEW -x RESTORE "$KEY" 0
            ;;
        *)
            $NEW DEL "$KEY"
            cat /tmp/dump | $NEW -x RESTORE "$KEY" "$TTL"
            ;;
    esac
    echo "$KEY (TTL = $TTL)"
done

```

> **NOTE** Add the `-c` option if running against a cluster as the source or target.

## Mass Insertion (redis-cli)

TODO

```bash
cat data.txt | redis-cli --pipe
```

## MIGRATE Command

TODO

```bash
redis-cli -n 2 keys '*' | xargs -I '{}' redis-cli -n 2 migrate my.redis 6379 "" 3 5000 KEYS '{}'

redis-cli --raw KEYS '*' | xargs redis-cli MIGRATE my.redis 6379 "" 0 5000 AUTH password-here KEYS
```

## Resources

- https://redis.io/topics/mass-insert

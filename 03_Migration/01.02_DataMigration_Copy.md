# Data Migration with Redis (Mass Insertion)

## Setup

Follow all the steps in the [Setup](./../05_Appendix/00_Setup.md) guide to create an environment to support the following steps.

## Connectivity Setup

In order to connect to Azure Redis, you must either enable non-SSL port, or you must install a tunneling tool.

### Install stunnel

```bash
sudo apt-get install stunnel4 -y
```

- Setup the SSL port for Azure Redis

```bash
sudo nano /etc/default/stunnel4
```

- Set the `Enabled` value to `1`
- Save the file
- Setup the pids directory and create the redis connection:

```bash
cd

mkdir pids

sudo chown -R nobody:nogroup pids/

sudo nano /etc/stunnel/redis.conf
```

- Add the following:

```text
[redis-cli]
client = yes
accept = 127.0.0.1:6380
connect = yourcachename.redis.cache.windows.net:6380
```

- Restart stunnel

```bash
/etc/init.d/stunnel4 restart
```

- Ensure that stunnel is running:

```bash
sudo apt install net-tools

sudo netstat -tlpn | grep 6380
```

### Enable Non-SSL Port

- Open the Azure Portal
- Browse to the Azure Cache for Redis
- Select **Non--SSL port (6379) disabled** link
- Select to enable the port
- Select **Save**

## Mass Insertion (SET)

- Run the following command to export all keys and values to a file
- Start a PowerShell session:

```bash
pwsh
```

- Run the following to dump all the keys and values:

```powershell
del "set.txt";

$keys = redis-cli keys "*"

foreach($key in $keys)
{
    $val = redis-cli get $key

    $line = $key + "`t" + $val;
    add-content "set.txt" $line;
}
```

- Run the following command to import all keys and values

```powershell
$lines = get-content "set.txt";

foreach($line in $lines)
{
    $vals = $line.split("`t");

    $key = $vals[0];
    $val = $vals[1];

    $ret = $val | redis-cli -h <redis name>.redis.cache.windows.net set $key $val;

    Write-Host "Setting $key to $val";
}
```

> **NOTE** This approach will lose important metadata such as Time To Live (TTL) settings that may be set in the source. You should also be sure that all values that are export and then re-imported are encoded in a way that ensures valid values imported into the target instance.

## Mass Insertion (DUMP/RESTORE)

```bash
export OLD="redis-cli -h localhost"
export NEW="redis-cli -h <REDIS_NAME>.redis.cache.windows.net -a <REDIS_KEY>"


for KEY in $($OLD --scan); do
    $OLD --raw DUMP "$KEY" | head -c-1 > /tmp/dump
    TTL=$($OLD --raw TTL "$KEY")
    case $TTL in
        -2)
            $NEW DEL "$KEY"
            ;;
        -1)
            $NEW DEL "$KEY"
            cat /tmp/dump | $NEW -x RESTORE "$KEY" 0
            ;;
        *)
            $NEW DEL "$KEY"
            cat /tmp/dump | $NEW -x RESTORE "$KEY" "$TTL"
            ;;
    esac
    echo "$KEY (TTL = $TTL)"
done

```

> **NOTE** Add the `-c` option if running against a cluster as the source or target.

## Mass Insertion (MIGRATE)

You can use the `MIGRATE` command to move key values to a new instance.

- If using stunnel, run the following:

```bash
redis-cli --scan | xargs redis-cli MIGRATE localhost 6380 "" 0 15000 AUTH <REDIS_PWD> KEYS
```

If using the non-SSL port, run the following:

```bash
redis-cli --scan | xargs redis-cli MIGRATE <REDIS_NAME>.redis.cache.windows.net 6
379 "" 0 15000 AUTH <REDIS_KEY> KEYS
```

> **NOTE** The target versions must be the same, or have similar encoding of the values in order for the MIGRATE command to succeed.

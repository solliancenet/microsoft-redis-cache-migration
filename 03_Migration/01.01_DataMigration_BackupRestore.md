# Data Migration with Backup and Restore

## Setup

Follow all the steps in the [Setup](./../05_Appendix/00_Setup.md) guide to create an environment to support the following steps.

## Data

> **NOTE** Format changes between versions may not be backwards compatible.

### Manual Backup

- Run the following command to find where your RDB file is located:

```bash
redis-cli config get dir
```

- Create a backup

```bash
bgsave
```

- Install Azure CLI

```bash
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```

- Run the following commands to save your RDB file to azure storage, be sure to replace the subscription id, resource group and storage account tokens:

```bash
az login

az ad signed-in-user show --query objectId -o tsv | az role assignment create --role "Storage Blob Data Contributor" --assignee @- --scope "/subscriptions/<subscription>/resourceGroups/<resource-group>/providers/Microsoft.Storage/storageAccounts/<storage-account>"

az storage container create --account-name <storage-account> --name <container> --auth-mode login

az storage blob upload  --account-name <storage-account> --container-name RedisBackup --name RedisBackup.rdb --file database.rdb --auth-mode login
```

### Manual Restore

- You can import the data using the Azure Portal or Azure CLI / PowerShell

```PowerShell
PS C:\>Import-AzRedisCache -ResourceGroupName "resourceGroupName" -Name "cacheName" -Files @("https://mystorageaccount.blob.core.windows.net/mycontainername/blobname?sv=2015-04-05&sr=b&sig=caIwutG2uDa0NZ8mjdNJdgOY8%2F8mhwRuGNdICU%2B0pI4%3D&st=2016-05-27T00%3A00%3A00Z&se=2016-05-28T00%3A00%3A00Z&sp=rwd") -Force
```

```bash
az redis import --files '("https://mystorageaccount.blob.core.windows.net/mycontainername/blobname?sv=2015-04-05&sr=b&sig=caIwutG2uDa0NZ8mjdNJdgOY8%2F8mhwRuGNdICU%2B0pI4%3D&st=2016-05-27T00%3A00%3A00Z&se=2016-05-28T00%3A00%3A00Z&sp=rwd")'  --file-format RDB --name "cacheName" --resource-group "resourceGroupName"            --subscription "subscriptionName"
```

> **Note** Each tier supports a maximum number of databases.  If you have more than the default of `16`, be sure that you pick a tier to migrate too that has support for all source databases.

## Summary - Backup and Restore

Even a simple backup and restore operation can potentially require significant effort to restore to an Azure Cache for Redis instance.

Practice the above steps and document any items that were removed from the backup script during the actual migration. Record the time it takes to complete the entire migration.

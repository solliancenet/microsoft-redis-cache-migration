# Data Migration with Backup and Restore (RDB)

## Setup

Follow all the steps in the [Setup](./../05_Appendix/00_Setup.md) guide to create an environment to support the following steps.

## Data

> **NOTE** RDB file format changes between versions may not be backwards compatible.

### Manual Backup

- Run the following command to find where your RDB file is located:

```bash
redis-cli config get dir

sudo chown -R $USER /var/lib/redis
```

- Create a backup

```bash
redis-cli bgsave
```

- Install Azure CLI

```bash
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```

- Run the following commands to save your RDB file to azure storage, be sure to replace the subscription id, resource group and storage account tokens:

> **NOTE** It can take a couple of minutes for the Azure RBAC assignment to go into effect.

```bash
az login

az account set --subscription "<subscription name>"

az ad signed-in-user show --query objectId -o tsv | az role assignment create --role "Storage Blob Data Contributor" --assignee @- --scope "/subscriptions/<subscription>/resourceGroups/<resource-group>/providers/Microsoft.Storage/storageAccounts/<storage-account>"

az storage container create --account-name <storage-account> --name <container> --auth-mode login

az storage blob upload  --account-name <storage-account> --container-name redis --name database.rdb --file /var/lib/redis/database.rdb --auth-mode login
```

### Manual Restore

- You can import the data using the Azure Portal or Azure CLI / PowerShell

```PowerShell
PS C:\>Import-AzRedisCache -ResourceGroupName "resourceGroupName" -Name "cacheName" -Files @("https://mystorageaccount.blob.core.windows.net/mycontainername/blobname?sv=2015-04-05&sr=b&sig=caIwutG2uDa0NZ8mjdNJdgOY8%2F8mhwRuGNdICU%2B0pI4%3D&st=2016-05-27T00%3A00%3A00Z&se=2016-05-28T00%3A00%3A00Z&sp=rwd") -Force
```

```bash
az redis import --files '("https://mystorageaccount.blob.core.windows.net/mycontainername/blobname?sv=2015-04-05&sr=b&sig=caIwutG2uDa0NZ8mjdNJdgOY8%2F8mhwRuGNdICU%2B0pI4%3D&st=2016-05-27T00%3A00%3A00Z&se=2016-05-28T00%3A00%3A00Z&sp=rwd")'  --file-format RDB --name "cacheName" --resource-group "resourceGroupName"            --subscription "subscriptionName"
```

> **Note** Each tier supports a maximum number of databases.  If you have more than the default of `16`, be sure that you pick a tier to migrate too that has support for all source databases.

### Check success

- Depending on the size of the file, it could take a while for the import to finish.  Once it is completed, verify that all keys have been migrated.

## Summary - Backup and Restore

Even a simple backup and restore operation can potentially require significant effort to restore to an Azure Cache for Redis instance.

Practice the above steps and record the time it takes to complete the entire migration.

# Data Migration with 3rd Party Tools

## Setup

Follow all the steps in the [Setup](./../05_Appendix/00_Setup.md) guide to create an environment to support the following steps.

> **Note** If the source server is not enabled for SSL and is running 6.0 or higher, it is highly recommended that it is enabled and configured.  See [Configure Redis for SSL connectivity](../05_Appendix/04_ConfigureRedisSSL.md) to enable SSL for the instance.

> **NOTE** Tools that use the `SLAVEOF` and `REPLICAOF` commands will not work with Azure Cache for Redis instances.

## Install STunnel

If you have not done so already, setup [STunnel](./../05_Appendix/03_InstallStunnel.md) if you are not running redis-cli 6.x or higher.

## Disable AOF in Target

To speed up the import, be sure to disable AOF in the target instance.

- Run the following on the target:

```bash
Set-AzRedisCache -Name <REDIS_NAME> -ResourceGroupName <RESOURCE_GROUP_NAME> -Aof 2.5GB

TODO

```

> **Note** Azure does not recognize the `CONFIG` command so all actions must be done through the Azure APIs : `redis-cli -h <REDIS_NAME>.redis.cache.windows.net -a <REDIS_KEY> config set appendonly no`

## Redis-migrate

- https://github.com/vipshop/redis-migrate-tool

- Download the source and compile the tool by running the following:

```bash
sudo apt-get install git-all
sudo apt-get install automake libtool autoconf bzip2

git clone https://github.com/vipshop/redis-migrate-tool

cd redis-migrate-tool
autoreconf -fvi
./configure
make
```

- Create a migration configuration file call `migrate.conf`
- Run the following:

```bash
sudo nano migrate.conf
```

- Copy the following into it, be sure to replace the target REdis instance name, port and password:

```text
[source]
type: single
servers:
 - 127.0.0.1:6379

[target]
type: single
redis_auth: <REDIS_PWD>
servers:
 - <REDIS_NAME>.redis.cache.windows.net:6379:1 server1

[common]
listen: 0.0.0.0:8888
threads: 2
step: 1
mbuf_size: 1024
source_safe: true
```

- To use the tool, run the following:

```bash
./src/redis-migrate-tool -c migrate.conf -o log -d
```

TODO - does this work?

- Check the status of the tool:

```bash
redis-cli -h 127.0.0.1 -p 8888
```

- Check that data in the source and target:

```bash
./src/redis-migrate-tool -c migrate.conf -o log -C redis_check
```

- Run a test insert

```bash
./src/redis-migrate-tool -c migrate.conf -o log -C "redis_testinsert"
```

## redis-copy (deepakverma)

This is a .NET based tool that uses the StackExchange.Redis library to move keys from the source to the destination. It uses the `DUMP` and `RESTORE` commands to make the move, which means the source and the destination should support the same encoding of the DUMP value.  Although the tools has not had any changes made to it in quite a while, the source is a great starting point for building your own version.

- Switch to the **win10** virtual machine
- Open a PowerShell window, run the following:

```PowerShell
git clone https://github.com/deepakverma/redis-copy
```

- Open the `redis-copy.sln` solution file
- Right-click the project file, select **Manage Nuget Packages**
- Select the **Installed** tab, then select **StackExchange.Redis**
- Update the package to be the latest version
- Press **Ctrl-B** to build the solution
- If the source system is running SSL, run the following,

```PowerShell
cd /redis-copy/bin/debug

redis-copy.exe --se localhost --sa "" --sp 6380 --sssl --db 0 --de <REDIS_NAME>.redis.cache.windows.net --da <REDIS_PWD> --dp 6380 --dssl --flushdest
```

- If the source system is not running SSL, run the following:

```PowerShell
cd /redis-copy/bin/debug

redis-copy.exe --se localhost --sa "" --sp 6379 --db 0 --de <REDIS_NAME>.redis.cache.windows.net --da <REDIS_PWD> --dp 6380 --dssl --flushdest
```

> **NOTE** You may need to make changes to the source to handle error such as DUMP/RESTORE encoding issues, this can be done by adding a method to check the version of the source and target Redis instances before you start the key migration.

## redis-copy (yaauie)

Another tool you can utilize the `redis-copy` command : https://github.com/yaauie/redis-copy.

```bash

sudo apt-get remove ruby ruby-dev

sudo apt-get install ruby ruby-dev

sudo gem install redis-copy
```

- Run the tool:

```bash
redis-copy --no-prompt redis://localhost:6379 redis://:<REDIS_PWD>@<REDIS_NAME>.redis.cache.windows.net:6380
```

## redis-dump (Ruby)

Redis-dump is a ruby based tool that also uses the DUMP and RESTORE commands to migrate from a source to a destination instance.

> **NOTE** This tool does not work on clusters.

- On the source server, run the following to install the tool:

```bash
sudo apt-get remove ruby ruby-dev

sudo apt-get install ruby ruby-dev

sudo apt-get install make pkg-config libssl-dev -y

sudo chmod -R a+w /var/lib/gems
sudo chmod -R a+w /usr/local/bin

gem install redis-dump -V
```

- Run the following to run the tool and dump the Redis cache to file:

```bash
redis-dump -u localhost:6379 > localhost.json
```

- Run the following to import the cache data:

```bash
cat localhost.json | redis-load -u redis://<REDIS_NAME>.redis.cache.windows.net:6380 -a <REDIS_PWD>
```

## redis-dump (NPM)

- Setup NPM

```bash
sudo apt-get install npm
```

- Install redis-dump

```bash
sudo npm install redis-dump -g
```

- Run the following to dump out the contents of the Redis cache

```bash
redis-dump > dump.txt 
```

- Run the following to execute the dump on the target

```bash
cat dump.txt | redis-cli -h <REDIS_NAME>.redis.cache.windows.net -p 6380 -a <REDIS_PWD>
```

You should now have the redis instance keys and values moved to the new Redis instance.

## Enable AOF in Target

If you disabled AOF in the target, re-enable it:

- Run the following on the target:

```bash
redis-cli config set appendonly yes
```

## Resources

- https://github.com/vipshop/redis-migrate-tool
- https://github.com/deepakverma/redis-copy